---
title: "Cortisol, oxytocin and social challenges in pigs"
subtitle: "Calibration of hormone measurements"
author: "Liza R. Moscovice, Anja Eggert and Ulrike Gimsa"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# include = FALSE prevents code and results from appearing in the finished file, but code runs.
# echo = FALSE prevents code, but not the results from appearing in the finished file.
# message = FALSE prevents messages that are generated by code from appearing in the finished file.
# warning = FALSE prevents warnings that are generated by code from appearing in the finished.
```

```{r libraries}
library(knitr)       # to render the document
library(kableExtra)  # nice html tables
library(tidyverse)   # load the tidyverse universe
library(lsmeans)     # compare slopes
library(patchwork)   # to combine subplots
library(ggpubr)      # add regression equation to ggplot
```

```{r}
my_theme = theme_classic() +
  theme(axis.title = element_text(face="bold", size=10),
        axis.text  = element_text(size=10, angle = 0, vjust = 0.5),
        plot.title = element_text(face="bold", size=10),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom")
```

\ 

# Data &  summary statistics

Here we read in the data table `calibration-curve.csv` and make some adjustments of the data format.

* change from character to date: `date`
* change from character to factor: `method`
* change from character to factor: `hormone`

```{r}
cali.curve <- read_csv(file = "./data/calibration-curve.csv")  

cali.curve <- cali.curve                 %>% 
  mutate(date    = lubridate::dmy(date)) %>% 
  mutate(method  = factor(method))       %>% 
  mutate(hormone = factor(hormone))      %>% 
  filter(logit_b.Bo <3)                        # exclude outliers

cali.curve %>% 
  tibble::rowid_to_column("#") %>% 
  kable(caption = "Data table") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 10) %>% 
  scroll_box(width = "800px", height = "400px")
```

\ 

# Comparison of slopes

* The R package `lsmeans` provides a function `lstrends()` for estimating and comparing the slopes of
fitted lines.
* We fit a linear model, extract slopes using `lstrends()` and then compare the slopes with `pairs()`
* `t.ratio` is given, which is the estimate divided by the standard error.

## Cortisol

```{r}
cali.cort <- cali.curve %>% 
  filter(hormone == "cort_ng_ml")

m.cort <- lm(logit_b.Bo ~ log.conc * method,
             data = cali.cort)

m.cort.lst <- lstrends(m.cort, ~ method, var = "log.conc")
m.cort.lst          # slope estimates and CIs
pairs(m.cort.lst)   # comparisons
```

\ 

## Oxytocin

```{r}
cali.oxyt <- cali.curve %>% 
  filter(hormone == "oxyt_pg_ml")

m.oxyt <- lm(logit_b.Bo ~ log.conc * method,
             data = cali.oxyt)

m.oxyt.lst <- lstrends(m.oxyt, ~ method, var = "log.conc")
m.oxyt.lst          # slope estimates and CIs
pairs(m.oxyt.lst)   # comparisons
```

\ 

# Figure

```{r}
# cortisol
p1 <- cali.cort %>% 
  ggplot(aes(x = log.conc, y = logit_b.Bo, col = method)) +
  geom_point(size = 2) + 
  geom_smooth(method = "lm", se = TRUE, formula = y ~ x,
              size = 0.8, alpha = 0.2) +
  stat_regline_equation(label.x = 0.3, label.y = c(1.36,2), show.legend = FALSE) +
  scale_colour_manual(name = NULL,
                      labels=c("Pooled saliva samples", "Kit standard curve"),
                      values=c("orange", "cornflowerblue")) +
  scale_x_continuous(lim = c(-1.1, 1.6), breaks = seq(-1, 1.6, 0.5)) +
  scale_y_continuous(lim = c(-2.7, 2.3), breaks = seq(-3, 2, 0.5)) +
  labs(x = c(expression(paste("Log concentration cortisol (ng ", ml^-1, ")"))),
       y = c(expression(paste("Logit b/", b[0]))),
       title = "Cortisol") +
  my_theme +
  guides(color=guide_legend(override.aes=list(fill=NA)))


# oxytocin
p2 <- cali.oxyt %>% 
  ggplot(aes(x = log.conc, y = logit_b.Bo, col = method)) +
  geom_point(size = 2) + 
  geom_smooth(method = "lm", se = TRUE, formula = y ~ x,
              size = 0.8, alpha = 0.2) +
  stat_regline_equation(label.x = 1.8, label.y = c(2.5,2), show.legend = FALSE) +
  scale_colour_manual(name = NULL,
                      labels=c("Pooled saliva samples", "Kit standard curve"),
                      values=c("orange", "cornflowerblue")) +
  scale_x_continuous(lim = c(1.2, 2.6), breaks = seq(1.2, 2.6, 0.2)) +
  scale_y_continuous(lim = c(-1, 2.6), breaks = seq(-1, 3, 0.5)) +
  labs(x = c(expression(paste("Log concentration oxytocin (pg ", ml^-1, ")"))),
       y = c(expression(paste("Logit b/", b[0]))),
       title = "Oxytocin") +
  my_theme +
  guides(color=guide_legend(override.aes=list(fill=NA)))

# combine
patchwork <- p2 + p1

patchwork +
  plot_layout(ncol = 2) +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = 'A',
                  tag_prefix = '(',
                  tag_suffix = ')') &
  theme(plot.tag = element_text(face = 'bold')) &
  theme(legend.position = "bottom")
```

\ 

# Session Info

```{r}
sessionInfo()
```
